name: ci

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master
        paths-ignore:
            - "frontend/**"

jobs:
    test:
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#choosing-github-hosted-runners
        runs-on: ubuntu-22.04
        steps:
            # https://github.com/marketplace/actions/checkout
            - uses: actions/checkout@v3.0.2
              with:
                  fetch-depth: 0
            # https://github.com/marketplace/actions/setup-go-environment
            - uses: actions/setup-go@v3.2.1
              with:
                  go-version: "1.19"
            - run: go version
            # https://github.com/marketplace/actions/run-golangci-lint
            - uses: golangci/golangci-lint-action@v3.2.0
              with:
                  version: v1.48.0
            - run: make test
              env:
                  ENV: "test"
                  SERVER: "http://localhost:8000"
                  PORT: "8000"
                  COOKIE_SECRET: "970a02fee5412b41db5c6efc4fe2e0e41bd682778cb1206bcbf295125622507f"
                  GITHUB_CLIENT_ID: "https://github.com/settings/developers"
                  GITHUB_CLIENT_SECRET: "https://github.com/settings/developers"
                  MAILGUN_API_KEY: "key-example"
                  MAILGUN_DOMAIN: "feedbox.example.com"
                  MAILGUN_FROM: "feedbox <feedbox@example.com>"
                  TELEGRAM_BOT_TOKEN: "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                  TELEGRAM_BOT_NAME: "bot_name"
                  TELEGRAM_WEBHOOK_PATH: "131cd9868e9cf396a807c265a3c97e72"
                  ROLLBAR_TOKEN: "post_server_item"
                  DATABASE_URL: "./feedbox.db"
    deploy:
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        needs: test
        runs-on: ubuntu-22.04
        steps:
            # https://github.com/marketplace/actions/checkout
            - uses: actions/checkout@v3.0.2
              with:
                  fetch-depth: 0
            # https://github.com/marketplace/actions/setup-node-js-environment
            - uses: actions/setup-node@v3.4.1
              with:
                  node-version: 18
            - run: node --version
            # https://github.com/marketplace/actions/cache
            - uses: actions/cache@v3.0.7
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-
            - run: |
                  corepack enable pnpm
                  pnpm install
                  # https://www.npmjs.com/package/wrangler
                  pnpm store prune
              env:
                  PNPM_HOME: /home/runner/.local/bin
              working-directory: ./frontend
            - run: make -j build
              working-directory: ./frontend
            # https://github.com/marketplace/actions/github-action-for-flyctl
            - uses: superfly/flyctl-actions/setup-flyctl@master
            # - run: |
            #       flyctl secrets set --stage COOKIE_SECRET=${{ secrets.COOKIE_SECRET }}
            #       flyctl secrets set --stage GITHUB_CLIENT_ID=${{ secrets.GH_CLIENT_ID }}
            #       flyctl secrets set --stage GITHUB_CLIENT_SECRET=${{ secrets.GH_CLIENT_SECRET }}
            #       flyctl secrets set --stage MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
            #       flyctl secrets set --stage TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            #       flyctl secrets set --stage TELEGRAM_WEBHOOK_PATH=${{ secrets.TELEGRAM_WEBHOOK_PATH }}
            #   env:
            #       FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
            - run: flyctl deploy --remote-only
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
