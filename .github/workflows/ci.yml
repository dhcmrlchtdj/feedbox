name: ci

on: [pull_request]

jobs:
    ci:
        runs-on: ubuntu-20.04
        services:
            postgres:
                image: postgres
                env:
                    POSTGRES_USER: user
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: feedbox
                ports: ['5432:5432']
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - uses: actions/checkout@v2.3.1
            - uses: actions/setup-node@v1.4.2
              with:
                  node-version: '14.x'
            - uses: actions/cache@v2.0.0
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-
            - run: make ci_test
              env:
                  NODE_ENV: 'development'
                  SERVER: 'http://localhost:8000'
                  COOKIE_SECRET: 'crypto.randomBytes(16).toString("hex")'
                  GITHUB_AUTH_SECRET: 'crypto.randomBytes(16).toString("hex")'
                  GITHUB_CLIENT_ID: 'https://github.com/settings/developers'
                  GITHUB_CLIENT_SECRET: 'https://github.com/settings/developers'
                  MAILGUN_API_KEY: 'key-example'
                  MAILGUN_DOMAIN: 'feedbox.example.com'
                  MAILGUN_FROM: 'feedbox <feedbox@example.com>'
                  TELEGRAM_BOT_TOKEN: '123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11'
                  TELEGRAM_WEBHOOK_PATH: 'crypto'
                  ROLLBAR_TOKEN: 'post_server_item'
                  DATABASE_URL: 'postgres://user:password@localhost:5432/feedbox'
                  NEW_RELIC_ENABLED: 'false'
                  NEW_RELIC_LICENSE_KEY: 'key'
                  NEW_RELIC_LOG: 'stdout'
                  NEW_RELIC_APP_NAME: 'feedbox'
                  NEW_RELIC_NO_CONFIG_FILE: 'true'
                  NEW_RELIC_LOG_LEVEL: 'info'
            - uses: codecov/codecov-action@v1.0.6
              with:
                  file: ./pkg/_build/coverage/coverage-final.json
