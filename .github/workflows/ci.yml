name: ci

on: [pull_request]

jobs:
    ci:
        runs-on: ubuntu-20.04
        services:
            postgres:
                image: postgres
                env:
                    POSTGRES_USER: user
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: feedbox
                ports: ['5432:5432']
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - uses: actions/checkout@v2.3.1
            - uses: actions/setup-go@v2.1.2
              with:
                  go-version: '1.x'
            - uses: actions/cache@v2.1.1
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: ${{ runner.os }}-go-
            - run: make test
              env:
                  ENV: 'test'
                  SERVER: 'http://localhost:8000'
                  PORT: '8000'
                  COOKIE_SECRET: '970a02fee5412b41db5c6efc4fe2e0e41bd682778cb1206bcbf295125622507f'
                  GITHUB_CLIENT_ID: 'https://github.com/settings/developers'
                  GITHUB_CLIENT_SECRET: 'https://github.com/settings/developers'
                  MAILGUN_API_KEY: 'key-example'
                  MAILGUN_DOMAIN: 'feedbox.example.com'
                  MAILGUN_FROM: 'feedbox <feedbox@example.com>'
                  TELEGRAM_BOT_TOKEN: '123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11'
                  TELEGRAM_BOT_NAME: 'bot_name'
                  ROLLBAR_TOKEN: 'post_server_item'
                  DATABASE_URL: 'postgres://user:password@localhost:5432/feedbox?sslmode=disable'
